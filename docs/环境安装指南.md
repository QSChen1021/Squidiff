# 环境安装指南

> Squidiff 项目的完整环境配置说明

## 快速安装

### 方法 1: 使用 requirements.txt 

```bash
# 进入项目目录
cd E:/Development/Squidiff

# 创建虚拟环境（推荐）
python -m venv .venv

# 激活虚拟环境
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

# 安装所有依赖（包括 rdkit）
pip install -r requirements.txt
```

### 方法 2: 使用 uv (最快，推荐)

```bash
# 安装 uv
pip install uv

# 创建虚拟环境并安装依赖
uv venv
.venv\Scripts\activate     # Windows
# 或
source .venv/bin/activate  # Linux/Mac

# 安装所有依赖（包括 rdkit）
uv pip install -r requirements.txt
```

### 方法 3: 使用 pyproject.toml

```bash
# 安装核心包
pip install -e .

# 安装所有可选依赖
pip install -e ".[all]"

# 或单独安装
pip install -e ".[drug]"  # 药物结构支持
pip install -e ".[dev]"   # 开发工具
```

---

## 依赖说明

### 核心依赖（必需）

| 包名 | 版本 | 用途 |
|------|------|------|
| torch | >=2.0.0 | 深度学习框架 |
| scanpy | >=1.9.0 | 单细胞数据分析 |
| anndata | >=0.8.0 | AnnData 格式支持 |
| h5py | >=3.8.0 | HDF5 文件格式 |
| numpy | >=1.24.0 | 数值计算 |
| scipy | >=1.10.0 | 科学计算 |
| scikit-learn | >=1.2.0 | 机器学习工具 |
| matplotlib | >=3.7.0 | 数据可视化 |
| tqdm | >=4.65.0 | 进度条 |
| tensorboard | >=2.13.0 | 训练可视化 |

### 可选依赖

| 包名 | 用途 | 安装方式 |
|------|------|----------|
| rdkit | 药物 SMILES 处理 | `uv pip install rdkit` 或 `conda install -c conda-forge rdkit` |
| PyQt5 | GUI 界面 | `pip install -e ".[gui]"` |
| rich/click | CLI 工具 | `pip install -e ".[cli]"` |
| ruff/black | 代码格式化 | `pip install -e ".[dev]"` |

---

## PyTorch 安装注意事项

PyTorch 需要根据您的 CUDA 版本选择对应的安装包：

### 检查 CUDA 版本

```bash
nvidia-smi  # Linux
nvcc --version  # Linux/Mac/Windows
```

### 安装命令

| CUDA 版本 | 安装命令 |
|-----------|----------|
| **CUDA 11.8** | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118` |
| **CUDA 12.1** | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121` |
| **CPU 版本** | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu` |

### 验证安装

```python
import torch
print(f"PyTorch 版本: {torch.__version__}")
print(f"CUDA 可用: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"CUDA 版本: {torch.version.cuda}")
```

---

## RDKit 安装注意事项

RDKit 现在可以通过多种方式安装：

```bash
# 方法 1: 使用 uv (推荐)
uv pip install rdkit

# 方法 2: 使用 pip
pip install rdkit

# 方法 3: 使用 conda (如果遇到问题)
conda install -c conda-forge rdkit
```

**注意**: uv 安装 rdkit 时会自动下载预编译的二进制包，通常比 pip 更快更可靠。

### 验证安装

```python
from rdkit import Chem
mol = Chem.MolFromSmiles("CC(=O)OC1=CC=CC=C1C(=O)O")
print(f"RDKit 安装成功: {mol is not None}")
```

---

## 验证安装

运行以下命令验证所有依赖已正确安装：

```bash
# 验证核心包
python -c "import torch; import scanpy as sc; import numpy as np; import scipy; import sklearn; print('核心包安装成功')"

# 验证 rdkit (可选)
python -c "from rdkit import Chem; print('RDKit 安装成功')"

# 运行数据验证脚本
python scripts/4.validate_data.py --data_path data/mast_cells_200genes.h5ad
```

---

## 常见问题

### Q1: pip 安装超时

**解决**: 使用国内镜像源
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q2: PyTorch CUDA 不匹配

**解决**: 根据您的 CUDA 版本重新安装 PyTorch（参考上面的表格）

### Q3: rdkit 安装失败

**解决**: 尝试以下方法

```bash
# 方法 1: 使用 uv (推荐)
uv pip install rdkit

# 方法 2: 使用 conda
conda install -c conda-forge rdkit

# 方法 3: 使用 pip 从 wheel 文件
pip install --only-binary :all: rdkit
```

### Q4: Windows 编译错误

**解决**: 使用预编译的二进制包
```bash
pip install --only-binary :all: -r requirements.txt
```

---

## 开发环境设置

如果需要进行开发工作，安装开发工具：

```bash
# 安装开发依赖
pip install -e ".[dev]"

# 配置 pre-commit hook
pip install pre-commit
pre-commit install
```

---

*最后更新: 2025-02-09*
