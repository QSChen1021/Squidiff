# Squidiff 部署与运行文档

> 合并说明：本文件已整合原 `部署文档.md` 与 `环境安装指南.md`，作为统一入口。

## 1. 适用范围

- 本文用于本地环境搭建、依赖安装、训练/推理运行与最小化验证。
- Seurat 数据转换请看 `docs/seurat转换指南.md`。
- 排错与快速定位请看 `docs/避坑指南.md`。

## 2. 环境要求

### 2.1 硬件建议

| 组件 | 最低配置 | 推荐配置 |
|---|---|---|
| CPU | 4 核 | 8 核及以上 |
| 内存 | 16 GB | 32 GB 及以上 |
| GPU | GTX 1060 6GB | RTX 3090/4090 24GB |
| 存储 | 50 GB | 100 GB+ SSD |

### 2.2 软件建议

- Python `3.11`（推荐）
- Windows / Linux / macOS
- GPU 训练建议安装与本机 CUDA 匹配的 PyTorch

## 3. 安装流程

### 3.1 使用 `uv`（推荐）

```bash
pip install uv
uv venv --python 3.11
```

```bash
# Windows
.venv\Scripts\activate

# Linux/macOS
source .venv/bin/activate
```

```bash
uv pip install -r requirements.txt
uv pip install -e ".[dev]"
```

### 3.2 使用 `pip`

```bash
# Windows
py -3.11 -m venv .venv

# Linux/macOS
python3.11 -m venv .venv
```

```bash
# Windows
.venv\Scripts\activate

# Linux/macOS
source .venv/bin/activate
```

```bash
pip install -r requirements.txt
pip install -e ".[dev]"
```

### 3.3 PyTorch 选择（按 CUDA）

| CUDA | 安装命令 |
|---|---|
| 11.8 | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118` |
| 12.1 | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121` |
| CPU | `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu` |

## 4. 安装验证

```bash
python -c "import torch, scanpy, anndata, numpy; print('core ok')"
python -c "from rdkit import Chem; print('rdkit ok')"
python -m ruff check .
```

## 5. 数据准备

### 5.1 最低输入要求

- `adata.X`：表达矩阵
- `adata.obs["Group"]`：分组标签
- 若 `use_drug_structure=True`：必须包含 `SMILES` 与 `dose`

### 5.2 维度一致性

先检查数据维度：

```bash
python scripts/check_shape.py --data_path path/to/train.h5ad
```

将输出的基因数同时用于：
- `--gene_size`
- `--output_dim`

## 6. 训练

### 6.1 基础训练

```bash
python train_squidiff.py \
  --logger_path "./results/baseline" \
  --data_path "path/to/train.h5ad" \
  --resume_checkpoint "./checkpoints/baseline" \
  --gene_size 159 \
  --output_dim 159
```

### 6.2 药物结构训练

```bash
python train_squidiff.py \
  --logger_path "./results/drug" \
  --data_path "path/to/train.h5ad" \
  --control_data_path "path/to/control.h5ad" \
  --resume_checkpoint "./checkpoints/drug" \
  --use_drug_structure True \
  --gene_size 159 \
  --output_dim 159
```

## 7. 推理

```python
import torch
import scanpy as sc
import sample_squidiff

sampler = sample_squidiff.sampler(
    model_path="checkpoints/baseline/model.pt",
    gene_size=159,
    output_dim=159,
    use_drug_structure=False,
)

adata = sc.read_h5ad("path/to/test.h5ad")
z_sem = sampler.model.encoder(torch.tensor(adata.X).to("cuda"))
pred = sampler.pred(z_sem, gene_size=adata.shape[1])
```

## 8. 常见运维问题

### 8.1 `CUDA out of memory`

- 降低 `--batch_size`
- 降低 `--gene_size`
- 启用 `--use_fp16 True`

### 8.2 维度不匹配 (`mat1 and mat2 shapes cannot be multiplied`)

- 检查 `adata.n_vars`
- 重新对齐 `--gene_size` 与 `--output_dim`

### 8.3 RDKit 安装失败

- 优先 `uv pip install rdkit`
- 备选 `conda install -c conda-forge rdkit`

## 9. 推荐实践

- 每次训练保存参数快照（JSON）
- 固定依赖版本后再做批量实验
- 先跑小样本验证，再上全量训练
