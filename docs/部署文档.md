# Squidiff 部署文档

> 基于扩散模型的单细胞转录组预测框架部署指南

## 目录

- [环境要求](#环境要求)
- [安装步骤](#安装步骤)
- [数据准备](#数据准备)
- [模型训练](#模型训练)
- [模型推理](#模型推理)
- [常见问题](#常见问题)

---

## 环境要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 4 核 | 8 核及以上 |
| 内存 | 16 GB | 32 GB 及以上 |
| GPU | NVIDIA GTX 1060 (6GB) | NVIDIA RTX 3090/4090 (24GB) |
| 存储 | 50 GB 可用空间 | 100 GB 及以上 SSD |

### 软件要求

- **操作系统**: Linux (Ubuntu 20.04+) / Windows 10+ / macOS 11+
- **Python**: 3.8 或更高版本
- **CUDA**: 11.0 或更高版本（GPU 训练必需）

---

## 安装步骤

### 方法一：使用 uv 安装（推荐）

[uv](https://github.com/astral-sh/uv) 是一个快速的 Python 包管理器，安装依赖更加高效。

#### 1. 安装 uv

```bash
# Linux/macOS
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# 或使用 pip
pip install uv
```

#### 2. 创建虚拟环境并安装依赖

```bash
# 克隆项目
git clone https://github.com/siyuh/Squidiff.git
cd Squidiff

# 使用 uv 创建虚拟环境并安装依赖
uv venv
source .venv/bin/activate  # Linux/macOS
# 或
.venv\Scripts\activate     # Windows

# 安装项目及依赖
uv pip install -e .
```

#### 3. 安装额外的深度学习依赖

```bash
# PyTorch（根据您的 CUDA 版本选择）
uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 或 CPU 版本
# uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# 其他依赖
uv pip install scanpy rdkit
```

### 方法二：使用 pip 安装

```bash
# 创建虚拟环境
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
# 或
.venv\Scripts\activate     # Windows

# 安装依赖
pip install -e .

# 安装 PyTorch（根据您的 CUDA 版本选择）
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 安装其他依赖
pip install scanpy rdkit
```

### 验证安装

```python
python -c "import torch; import scanpy as sc; import rdkit; print('安装成功！')"
```

---

## 数据准备

### 输入数据格式

Squidiff 接受 **h5ad 格式**的单细胞数据文件，需包含以下内容：

| 字段 | 类型 | 说明 |
|------|------|------|
| `.X` | 矩阵 | 单细胞计数矩阵（基因表达矩阵） |
| `.obs` | DataFrame | 元数据，需包含 `Group` 列 |
| `.obs['SMILES']` | str | 药物 SMILES 字符串（使用药物结构时必需） |
| `.obs['dose']` | float | 药物剂量（使用药物结构时必需） |

### 从 Seurat (R) 转换数据

如果您使用的是 Seurat 对象，需要先将其转换为 h5ad 格式。详见 [Seurat 数据转换指南](./seurat转换指南.md)。

### 数据集目录结构

```
Squidiff/
├── datasets/
│   ├── train_data.h5ad        # 训练数据
│   ├── control_data.h5ad      # 对照组数据（使用药物结构时必需）
│   └── test_data.h5ad         # 测试数据
```

---

## 模型训练

### 基础训练

不使用药物结构的基础训练命令：

```bash
python train_squidiff.py \
  --logger_path logger_files/my_experiment \
  --data_path datasets/train_data.h5ad \
  --resume_checkpoint my_model \
  --gene_size 500 \
  --output_dim 500
```

**参数说明：**

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `--logger_path` | 日志保存路径 | `logger_files/my_experiment` |
| `--data_path` | 训练数据路径 | `datasets/train_data.h5ad` |
| `--resume_checkpoint` | 模型检查点名称 | `my_model` |
| `--gene_size` | 输入基因数量 | `500` |
| `--output_dim` | 输出维度 | `500` |

### 使用药物结构的训练

如果您的数据包含药物 SMILES 和剂量信息：

```bash
python train_squidiff.py \
  --logger_path logger_files/drug_experiment \
  --data_path datasets/sci_plex_train.h5ad \
  --control_data_path datasets/sci_plex_control.h5ad \
  --resume_checkpoint sciplex_results \
  --use_drug_structure True \
  --gene_size 200 \
  --output_dim 200
```

**额外参数说明：**

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `--use_drug_structure` | 是否使用药物结构 | `True` |
| `--control_data_path` | 对照组数据路径 | `datasets/sci_plex_control.h5ad` |
| `--drug_dimension` | 药物指纹维度 | `1024`（默认） |
| `--comb_num` | 药物组合数量 | `1`（默认） |

### 训练监控

训练过程中，日志将保存在 `--logger_path` 指定的目录中。您可以使用 TensorBoard 监控训练：

```bash
tensorboard --logdir logger_files/
```

---

## 模型推理

### Python API 推理

```python
import sample_squidiff
import torch
import scanpy as sc

# 1. 初始化采样器
sampler = sample_squidiff.sampler(
    model_path='path/to/your/model.pt',
    gene_size=500,           # 与训练时一致
    output_dim=500,          # 与训练时一致
    use_drug_structure=False # 与训练时一致
)

# 2. 加载测试数据
test_adata = sc.read_h5ad('datasets/test_data.h5ad')

# 3. 获取编码表示
z_sem = sampler.model.encoder(
    torch.tensor(test_adata.X).to('cuda')
)

# 4. 预测转录组
scrnas_pred = sampler.pred(
    z_sem,
    gene_size=test_adata.shape[1]
)

# 5. 保存结果
test_adata.obsm['predicted'] = scrnas_pred.cpu().numpy()
test_adata.write('datasets/test_result.h5ad')
```

### 使用药物结构的推理

```python
sampler = sample_squidiff.sampler(
    model_path='path/to/model.pt',
    gene_size=200,
    output_dim=200,
    use_drug_structure=True
)

# 加载测试数据（需包含 SMILES 和 dose 列）
test_adata = sc.read_h5ad('datasets/test_data.h5ad')

# 预测
# ... 具体实现请参考 sample_squidiff.py
```

---

## 常见问题

### 1. CUDA Out of Memory 错误

**问题**: `RuntimeError: CUDA out of memory`

**解决方案**:
- 减小 `--gene_size` 参数
- 减小 batch size（修改代码中的 batch_size 参数）
- 使用更小的模型（减少 `--num_layers` 或 `--num_channels`）

### 2. 数据维度不匹配

**问题**: `RuntimeError: mat1 and mat2 shapes cannot be multiplied`

**解决方案**:
- 确保 `--gene_size` 与实际数据的基因数匹配
- 确保 `--output_dim` 与训练时设置的值一致

### 3. h5ad 文件读取错误

**问题**: 读取 h5ad 文件时报错

**解决方案**:
- 确保安装了 `h5py`: `uv pip install h5py`
- 检查文件是否损坏
- 确认 scanpy 版本兼容性

### 4. RDKit 安装失败

**问题**: rdkit 安装报错

**解决方案**:
```bash
# 使用 conda 安装（推荐）
conda install -c conda-forge rdkit

# 或使用预编译的 wheel
pip install rdkit
```

### 5. 训练不收敛

**问题**: 训练损失不下降或震荡

**解决方案**:
- 检查学习率设置
- 检查数据质量和预处理
- 尝试调整 `--noise_schedule` 参数
- 增加训练轮数

---

## 引用

如果 Squidiff 对您的研究有帮助，请引用：

```bibtex
@article{he2025squidiff,
  title={Squidiff: predicting cellular development and responses to perturbations using a diffusion model},
  author={He, Siyu and Zhu, Yue and Tavakol, Danial N and others},
  journal={Nature Methods},
  year={2025},
  doi={https://doi.org/10.1038/s41592-025-02877-y}
}
```

---

## 联系方式

如有问题或建议，请通过以下方式联系：

- **GitHub Issues**: https://github.com/siyuh/Squidiff/issues
- **Email**: siyuhe@stanford.edu

---

*文档最后更新：2025年*
